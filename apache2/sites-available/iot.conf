<VirtualHost *:443>
    ServerName iotlab201.eie.ucr.ac.cr

    # — 1. Activa SSL en este virtualhost —
    SSLEngine on

    # — 2. Permite proxy sobre conexiones SSL (aunque tu backend sea HTTP) —
    SSLProxyEngine On

    # — 3. Configuración básica de proxy inverso —
    ProxyPreserveHost On    # Mantiene el Host original (api.midominio.com) en la cabecera Host
    ProxyRequests Off       # Desactiva proxy forward (solo queremos reverse-proxy)

    ProxyPass        / http://127.0.0.1:8000/      
    ProxyPassReverse / http://127.0.0.1:8000/      

    # — 4. Cabeceras para Django (SECURE_PROXY_SSL_HEADER, X-Forwarded-Host, etc.) —
   # RequestHeader set X-Forwarded-Proto "https"
   # RequestHeader set X-Forwarded-Host  "%{HTTP_HOST}e"
   # RequestHeader set X-Forwarded-For   "%{REMOTE_ADDR}e"
    RequestHeader set X-Forwarded-Proto "https" early
    RequestHeader set X-Forwarded-Host  "%{HTTP_HOST}e" early

    LogFormat "%{Host}i %{X-Forwarded-Proto}i -> backend" debughost
    CustomLog /var/log/apache2/debug-host.log debughost


    # — 5. Permitir que Apache realice el proxy a cualquier destino —
    <Proxy *>
        Require all granted
    </Proxy>

    # — 6. Certificados Let’s Encrypt —
    SSLCertificateFile /etc/letsencrypt/live/iotlab201.eie.ucr.ac.cr/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/iotlab201.eie.ucr.ac.cr/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>

